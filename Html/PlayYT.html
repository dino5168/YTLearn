<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SRT å­—å¹•æ’­æ”¾å™¨</title>
    <style>
      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        max-width: 1200px; /* å¢åŠ æœ€å¤§å¯¬åº¦ä»¥å®¹ç´ YouTube æ’­æ”¾å™¨ */
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: flex; /* ä½¿ç”¨ Flexbox ä½ˆå±€ */
        gap: 20px; /* å…ƒç´ é–“è· */
      }

      .left-panel {
        flex: 2; /* å·¦å´é¢æ¿ä½”ç”¨æ›´å¤šç©ºé–“ */
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .right-panel {
        flex: 1; /* å³å´é¢æ¿ä½”ç”¨è¼ƒå°‘ç©ºé–“ */
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      h1 {
        text-align: center;
        color: #4a5568;
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: 300;
      }

      .upload-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .upload-section:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
      }

      .file-input {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        width: 100%;
        font-size: 16px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 20px 0;
        padding: 20px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 12px;
      }

      .time-input {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        width: 100px;
      }

      button {
        padding: 10px 20px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .timeline {
        margin: 20px 0;
      }

      .timeline-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e2e8f0;
        outline: none;
        cursor: pointer;
        -webkit-appearance: none;
      }

      .timeline-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(45deg, #667eea, #764ba2);
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.5);
      }

      .time-display {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 14px;
        color: #718096;
      }

      .subtitle-list {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 20px;
        background: #f7fafc;
        scroll-behavior: smooth;
      }

      .subtitle-item {
        padding: 10px 15px;
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .subtitle-item:last-child {
        border-bottom: none; /* æœ€å¾Œä¸€å€‹é …ç›®æ²’æœ‰ä¸‹é‚Šæ¡† */
      }

      .subtitle-item:hover {
        background: rgba(102, 126, 234, 0.1);
      }

      .subtitle-item.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .subtitle-item .time {
        font-size: 12px;
        color: #718096;
        margin-bottom: 5px;
      }

      .subtitle-item.active .time {
        color: rgba(255, 255, 255, 0.8);
      }

      .youtube-section {
        margin-bottom: 20px;
        padding: 20px;
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        text-align: center;
      }

      .youtube-section input {
        width: calc(100% - 22px); /* èª¿æ•´è¼¸å…¥æ¡†å¯¬åº¦ */
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      #youtube-player {
        width: 100%;
        /* è¨ˆç®—å¯¬é«˜æ¯”ä»¥ç¶­æŒå½±ç‰‡æ¯”ä¾‹ */
        aspect-ratio: 16 / 9; /* 16:9 æ¯”ä¾‹ */
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left-panel">
        <h1>ğŸ¬ SRT å­—å¹•æ’­æ”¾å™¨</h1>

        <div class="youtube-section">
          <label for="youtubeUrl">ğŸ”— è¼¸å…¥ YouTube å½±ç‰‡ç¶²å€ï¼š</label>
          <input
            type="text"
            id="youtubeUrl"
            placeholder="ä¾‹å¦‚ï¼šhttps://www.youtube.com/watch?v=dQw4w9WgXcQ" />
          <button onclick="loadYouTubeVideo()">è¼‰å…¥å½±ç‰‡</button>
          <div id="youtube-player"></div>
        </div>

        <div class="controls">
          <label>â° è·³è‡³æ™‚é–“ï¼š</label>
          <input
            type="text"
            id="timeInput"
            class="time-input"
            placeholder="00:00:00" />
          <button onclick="jumpToTime()">è·³è‡³</button>
          <button id="playPauseButton" onclick="togglePlay()">â–¶ï¸ æ’­æ”¾</button>
          <button onclick="resetTime()">ğŸ”„ é‡ç½®</button>
        </div>

        <div class="timeline">
          <input
            type="range"
            id="timelineSlider"
            class="timeline-slider"
            min="0"
            max="100"
            value="0" />
          <div class="time-display">
            <span id="currentTime">00:00:00</span>
            <span id="totalTime">00:00:00</span>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="upload-section">
          <label for="srtFile">ğŸ“ é¸æ“‡ SRT å­—å¹•æª”æ¡ˆï¼š</label>
          <input type="file" id="srtFile" class="file-input" accept=".srt" />
        </div>
        <div
          class="subtitle-list"
          id="subtitleList"
          style="display: none"></div>
      </div>
    </div>

    <script>
      let subtitles = [];
      let player; // YouTube æ’­æ”¾å™¨å¯¦ä¾‹
      let isPlaying = false;
      let playInterval;
      let totalDuration = 0;

      // è¼‰å…¥ YouTube IFrame Player API
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // ç•¶ YouTube API è¼‰å…¥å®Œæˆæ™‚æœƒå‘¼å«æ­¤å‡½æ•¸
      function onYouTubeIframeAPIReady() {
        // åˆå§‹åŒ–æ’­æ”¾å™¨ï¼Œä½†æš«æ™‚ä¸è¼‰å…¥å½±ç‰‡
        player = new YT.Player("youtube-player", {
          height: "360", // é è¨­é«˜åº¦ï¼Œæœƒåœ¨ CSS ä¸­èª¿æ•´
          width: "640", // é è¨­å¯¬åº¦ï¼Œæœƒåœ¨ CSS ä¸­èª¿æ•´
          videoId: "", // åˆå§‹ä¸è¼‰å…¥ä»»ä½•å½±ç‰‡
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });
      }

      function onPlayerReady(event) {
        console.log("YouTube Player is ready.");
        // å¯ä»¥åœ¨é€™è£¡è¨­å®šä¸€äº›åˆå§‹å€¼ï¼Œä¾‹å¦‚æ’­æ”¾éŸ³é‡
        // event.target.setVolume(100);
      }

      function onPlayerStateChange(event) {
        const playPauseButton = document.getElementById("playPauseButton");
        // ç•¶æ’­æ”¾å™¨ç‹€æ…‹æ”¹è®Šæ™‚
        if (event.data == YT.PlayerState.PLAYING) {
          // å½±ç‰‡æ­£åœ¨æ’­æ”¾
          isPlaying = true;
          playPauseButton.textContent = "â¸ï¸ æš«åœ";
          // é–‹å§‹æ¯ 100 æ¯«ç§’æ›´æ–°ä¸€æ¬¡å­—å¹•å’Œæ™‚é–“è»¸
          if (!playInterval) {
            playInterval = setInterval(syncWithYouTubePlayer, 100);
          }
        } else {
          // å½±ç‰‡æš«åœæˆ–çµæŸ
          isPlaying = false;
          playPauseButton.textContent = "â–¶ï¸ æ’­æ”¾";
          clearInterval(playInterval); // åœæ­¢æ›´æ–°
          playInterval = null;
        }
        // ç¢ºä¿ç•¶æ’­æ”¾å™¨æ™‚é–“æ”¹è®Šæ™‚ï¼Œæ›´æ–°å­—å¹•é¡¯ç¤º
        updateSubtitleDisplay();
      }

      document
        .getElementById("srtFile")
        .addEventListener("change", handleFileSelect);
      document
        .getElementById("timelineSlider")
        .addEventListener("input", handleTimelineChange);

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file && file.name.endsWith(".srt")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const srtContent = e.target.result;
            subtitles = parseSRT(srtContent);
            displaySubtitleList();
            // é‡ç½®æ™‚é–“æ‡‰ç”± YouTube æ’­æ”¾å™¨æ±ºå®š
            // resetTime();
            updateTotalTime();
            document.getElementById("subtitleList").style.display = "block";
          };
          reader.readAsText(file, "UTF-8");
        }
      }

      function parseSRT(srtText) {
        const blocks = srtText.trim().split(/\n\s*\n/);
        return blocks
          .map((block) => {
            const lines = block.trim().split("\n");
            if (lines.length >= 3) {
              const timeMatch = lines[1].match(
                /(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/
              );
              if (timeMatch) {
                return {
                  start: timeToSeconds(timeMatch[1]),
                  end: timeToSeconds(timeMatch[2]),
                  text: lines.slice(2).join("\n"),
                };
              }
            }
            return null;
          })
          .filter(Boolean);
      }

      function timeToSeconds(timeStr) {
        const [time, ms] = timeStr.split(",");
        const [hours, minutes, seconds] = time.split(":").map(Number);
        return hours * 3600 + minutes * 60 + seconds + (ms ? ms / 1000 : 0); // ç¢ºä¿ ms å­˜åœ¨
      }

      function secondsToTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
      }

      // ä½¿ç”¨ YouTube æ’­æ”¾å™¨çš„æ™‚é–“æ›´æ–°å­—å¹•é¡¯ç¤º
      function syncWithYouTubePlayer() {
        if (player && player.getCurrentTime) {
          currentTime = player.getCurrentTime();
          updateSubtitleDisplay();
          // å¦‚æœå½±ç‰‡æ’­æ”¾çµæŸï¼Œåœæ­¢æ›´æ–°ä¸¦é‡ç½®æ’­æ”¾å™¨ç‹€æ…‹
          if (player.getPlayerState() === YT.PlayerState.ENDED) {
            clearInterval(playInterval);
            playInterval = null;
            isPlaying = false;
            document.getElementById("playPauseButton").textContent = "â–¶ï¸ æ’­æ”¾";
          }
        }
      }

      function updateSubtitleDisplay() {
        document.getElementById("currentTime").textContent =
          secondsToTime(currentTime);

        const progress =
          totalDuration > 0 ? (currentTime / totalDuration) * 100 : 0;
        document.getElementById("timelineSlider").value = progress;

        updateSubtitleListHighlight();
      }

      function displaySubtitleList() {
        const listContainer = document.getElementById("subtitleList");
        listContainer.innerHTML = "";

        subtitles.forEach((subtitle, index) => {
          const item = document.createElement("div");
          item.className = "subtitle-item";
          item.innerHTML = `
                    <div class="time">${secondsToTime(
                      subtitle.start
                    )} â†’ ${secondsToTime(subtitle.end)}</div>
                    <div>${subtitle.text}</div>
                `;
          item.onclick = () => jumpToSubtitle(subtitle.start);
          listContainer.appendChild(item);
        });
      }

      function updateSubtitleListHighlight() {
        const items = document.querySelectorAll(".subtitle-item");
        let activeItemFound = false; // ç”¨ä¾†æ¨™è¨˜æ˜¯å¦æ‰¾åˆ°æ´»èºå­—å¹•

        items.forEach((item, index) => {
          const subtitle = subtitles[index];
          if (
            subtitle &&
            currentTime >= subtitle.start &&
            currentTime < subtitle.end
          ) {
            // ä½¿ç”¨ < é¿å…çµæŸæ™‚é–“é‡è¤‡é«˜äº®
            if (!item.classList.contains("active")) {
              // é¿å…é‡è¤‡æ“ä½œ DOM
              item.classList.add("active");
              item.style.background =
                "linear-gradient(45deg, #667eea, #764ba2)";
              item.style.color = "white";
              activeItemFound = true;
              // æ»¾å‹•åˆ°æ´»èºå­—å¹•
              item.scrollIntoView({
                behavior: "smooth",
                block: "center",
                inline: "nearest",
              });
            }
          } else {
            if (item.classList.contains("active")) {
              // é¿å…é‡è¤‡æ“ä½œ DOM
              item.classList.remove("active");
              item.style.background = "";
              item.style.color = "";
            }
          }
        });
      }

      function jumpToSubtitle(time) {
        if (player && player.seekTo) {
          player.seekTo(time, true); // è·³è½‰ YouTube å½±ç‰‡æ™‚é–“
          // currentTime æœƒç”± onPlayerStateChange é€é syncWithYouTubePlayer è‡ªå‹•æ›´æ–°
        } else {
          currentTime = time; // å¦‚æœæ²’æœ‰ YouTube æ’­æ”¾å™¨ï¼Œå‰‡åƒ…æ›´æ–°æœ¬åœ°æ™‚é–“
          updateSubtitleDisplay();
        }
      }

      function togglePlay() {
        if (!player) {
          alert("è«‹å…ˆè¼‰å…¥ YouTube å½±ç‰‡ã€‚");
          return;
        }

        if (isPlaying) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
        // onPlayerStateChange æœƒè™•ç† isPlaying å’ŒæŒ‰éˆ•æ–‡å­—æ›´æ–°
      }

      function jumpToTime() {
        const timeStr = document.getElementById("timeInput").value;
        const timePattern = /^(\d{1,2}):(\d{2}):(\d{2})$/;
        const match = timeStr.match(timePattern);

        if (match) {
          const [, hours, minutes, seconds] = match;
          const targetTime =
            parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds);
          jumpToSubtitle(targetTime); // è·³è½‰åˆ°æŒ‡å®šæ™‚é–“
        } else {
          alert("è«‹è¼¸å…¥æ­£ç¢ºçš„æ™‚é–“æ ¼å¼ï¼ˆHH:MM:SSï¼‰");
        }
      }

      function resetTime() {
        if (player && player.seekTo) {
          player.seekTo(0, true); // å°‡ YouTube å½±ç‰‡è·³è½‰åˆ° 0
          player.pauseVideo(); // æš«åœå½±ç‰‡
        }
        currentTime = 0; // é‡ç½®æœ¬åœ°æ™‚é–“
        clearInterval(playInterval);
        playInterval = null;
        isPlaying = false;
        document.getElementById("playPauseButton").textContent = "â–¶ï¸ æ’­æ”¾";
        updateSubtitleDisplay();
      }

      function handleTimelineChange(event) {
        const progress = event.target.value;
        if (totalDuration > 0) {
          const targetTime = (progress / 100) * totalDuration;
          if (player && player.seekTo) {
            player.seekTo(targetTime, true);
          } else {
            currentTime = targetTime;
            updateSubtitleDisplay();
          }
        }
      }

      function updateTotalTime() {
        if (player && player.getDuration) {
          totalDuration = player.getDuration();
        } else if (subtitles.length > 0) {
          totalDuration = Math.max(...subtitles.map((sub) => sub.end));
        }
        document.getElementById("totalTime").textContent =
          secondsToTime(totalDuration);
        document.getElementById("timelineSlider").max = 100;
      }

      // è¼‰å…¥ YouTube å½±ç‰‡
      function loadYouTubeVideo() {
        const youtubeUrl = document.getElementById("youtubeUrl").value;
        let videoId = "";

        // å˜—è©¦å¾å„ç¨® YouTube ç¶²å€æ ¼å¼ä¸­æå– video ID
        const regExp =
          /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
        const match = youtubeUrl.match(regExp);
        if (match && match[1]) {
          videoId = match[1];
        }

        if (videoId) {
          if (player) {
            player.loadVideoById(videoId);
            updateTotalTime(); // è¼‰å…¥æ–°å½±ç‰‡å¾Œæ›´æ–°ç¸½æ™‚é•·
          } else {
            // å¦‚æœ player é‚„æ²’åˆå§‹åŒ–ï¼Œé€™è¡¨ç¤º onYouTubeIframeAPIReady é‚„æ²’è¢«å‘¼å«
            // ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿï¼Œå› ç‚º script æ¨™ç±¤æ˜¯åŒæ­¥è¼‰å…¥çš„
            console.error("YouTube Player not initialized.");
          }
        } else {
          alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube å½±ç‰‡ç¶²å€ã€‚");
        }
      }

      // åˆå§‹åŒ–é¡¯ç¤º
      updateSubtitleDisplay();
    </script>
  </body>
</html>
